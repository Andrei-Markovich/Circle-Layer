name: Deploy SimpleStorage

on:
  workflow_dispatch: {}

permissions:
  contents: write     # чтобы коммитить deployments/*
  actions: write      # чтобы обновить Actions Variable SIMPLE_STORAGE

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      # сеть и секреты для hardhat
      NETWORK: circleLayerTestnet
      CIRCLE_RPC_URL: ${{ secrets.CIRCLE_RPC_URL }}
      PRIVATE_KEY:    ${{ secrets.PRIVATE_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # ⬇️ ключевой фикс: полностью вырубаем optional deps (fsevents и т.п.)
      - name: Install deps (Linux-safe, no optional)
        env:
          NPM_CONFIG_OPTIONAL: "false"
        shell: bash
        run: |
          set -e
          npm ci --omit=optional --no-optional || npm install --omit=optional --no-optional
          npm prune --omit=optional
          # На всякий случай показываем, что fsevents отсутствует, но не падаем
          npm ls fsevents || true

      - name: Compile (ensure analyzer)
        shell: bash
        run: |
          node -e "try{require.resolve('@nomicfoundation/solidity-analyzer-linux-x64-gnu');process.exit(0)}catch(e){process.exit(1)}" \
          || npm i -D @nomicfoundation/solidity-analyzer-linux-x64-gnu
          npx hardhat compile

      - name: Deploy
        run: npx hardhat run scripts/deploySimpleStorage.js --network ${{ env.NETWORK }}

      - name: Read deployed address
        id: read
        run: |
          ADDR=$(jq -r '.address' deployments/${{ env.NETWORK }}/SimpleStorage.json)
          echo "addr=$ADDR" >> $GITHUB_OUTPUT
          {
            echo "### Deploy completed"
            echo
            echo "- **Network:** \`${{ env.NETWORK }}\`"
            echo "- **Address:** \`$ADDR\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Update Actions variable SIMPLE_STORAGE
        if: ${{ steps.read.outputs.addr != '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api -X PUT \
            "repos/${{ github.repository }}/actions/variables/SIMPLE_STORAGE" \
            -f name="SIMPLE_STORAGE" \
            -f value="${{ steps.read.outputs.addr }}"

      # аккуратно подтянем удалённые коммиты, чтобы push прошёл
      - name: Rebase with origin/main
        run: |
          git config user.name  "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git pull --rebase origin main || true

      - name: Commit deployments file
        run: |
          git add deployments/${{ env.NETWORK }}/SimpleStorage.json
          git commit -m "ci: track deployed SimpleStorage address" || echo "Nothing to commit"

      - name: Push
        run: |
          git push origin HEAD:main || echo "push skipped"
