name: Deploy SimpleStorage

on:
  workflow_dispatch:

permissions:
  contents: write      # чтобы коммитить deployments/*
  actions: write       # чтобы писать repo variables через GITHUB_TOKEN

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      NETWORK: circleLayerTestnet

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # Установка зависимостей без optional (fsevents и т.п.)
      - name: Install deps (Linux-safe, omit optional)
        run: |
          set -e
          npm ci --omit=optional
          npm prune --omit=optional
          npm ls fsevents || true

      - name: Compile (ensure analyzer)
        shell: bash
        run: |
          node -e "try{require.resolve('@nomicfoundation/solidity-analyzer-linux-x64-gnu');process.exit(0)}catch(e){process.exit(1)}" \
          || npm i -D @nomicfoundation/solidity-analyzer-linux-x64-gnu
          npx hardhat compile

      - name: Deploy
        env:
          CIRCLE_RPC_URL: ${{ secrets.CIRCLE_RPC_URL }}
          PRIVATE_KEY:    ${{ secrets.PRIVATE_KEY }}
        run: npx hardhat run scripts/deploySimpleStorage.js --network $NETWORK

      - name: Read deployed address
        id: addr
        run: |
          ADDR=$(node -p "require('./deployments/${{ env.NETWORK }}/SimpleStorage.json').address || ''")
          echo "address=$ADDR" >> "$GITHUB_OUTPUT"
          echo "Network:  $NETWORK" >> "$GITHUB_STEP_SUMMARY"
          echo "Address:  $ADDR"    >> "$GITHUB_STEP_SUMMARY"

      # <<< фикс — создаем/обновляем repo variable SIMPLE_STORAGE >>>
      - name: Update Actions variable SIMPLE_STORAGE
        if: steps.addr.outputs.address != ''
        env:
          GH_TOKEN: ${{ github.token }}   # работает благодаря permissions: actions: write
        run: |
          gh variable set SIMPLE_STORAGE --repo "$GITHUB_REPOSITORY" --body "${{ steps.addr.outputs.address }}"
      # >>> конец фикса

      # Сохраняем файл deployments/* в репозиторий
      - name: Rebase with origin/main
        env:
          GIT_AUTHOR_NAME:  github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME:  github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          git fetch origin main
          git rebase origin/main || git rebase --abort
          git add deployments/${{ env.NETWORK }}/SimpleStorage.json
          git commit -m "chore(ci): persist SimpleStorage address ${{ steps.addr.outputs.address }}" || echo "nothing to commit"
          git push origin HEAD:main
