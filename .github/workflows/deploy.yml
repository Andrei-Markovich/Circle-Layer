name: Deploy SimpleStorage

on:
  workflow_dispatch: {}

permissions:
  contents: write   # чтобы коммитить deployments/*
  actions: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      NETWORK: circleLayerTestnet

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps (Linux-safe, omit optional)
        run: |
          set -e
          npm ci --omit=optional
          npm prune --omit=optional
          npm ls fsevents || true

      - name: Compile (ensure analyzer)
        shell: bash
        run: |
          node -e "try{require.resolve('@nomicfoundation/solidity-analyzer-linux-x64-gnu');process.exit(0)}catch(e){process.exit(1)}" \
          || npm i -D @nomicfoundation/solidity-analyzer-linux-x64-gnu
          npx hardhat compile

      - name: Deploy
        env:
          CIRCLE_RPC_URL: ${{ secrets.CIRCLE_RPC_URL }}
          PRIVATE_KEY:    ${{ secrets.PRIVATE_KEY }}
        run: npx hardhat run --network $NETWORK scripts/deploySimpleStorage.js

      - name: Read deployed address
        run: |
          set -e
          FILE="deployments/${NETWORK}/SimpleStorage.json"
          ADDR=$(node -e "const fs=require('fs');const j=JSON.parse(fs.readFileSync(process.argv[1],'utf8'));process.stdout.write(j.address||'');" "$FILE")
          echo "ADDRESS=$ADDR" >> $GITHUB_ENV
          echo "Network:  $NETWORK" >> $GITHUB_STEP_SUMMARY
          echo "Address:  $ADDR" >> $GITHUB_STEP_SUMMARY
          test -n "$ADDR"

      - name: Export ABI for artifacts
        run: node scripts/exportAbi.js

      - name: List outputs
        run: |
          echo "## Files" >> $GITHUB_STEP_SUMMARY
          ls -la abi || true >> $GITHUB_STEP_SUMMARY
          ls -la "deployments/${NETWORK}" || true >> $GITHUB_STEP_SUMMARY
          ls -la artifacts/contracts/SimpleStorage.sol || true >> $GITHUB_STEP_SUMMARY

      - name: Upload ABI
        uses: actions/upload-artifact@v4
        with:
          name: abi-${{ github.run_id }}
          path: abi/SimpleStorage.json
          if-no-files-found: error
          retention-days: 14

      - name: Upload deployment JSON
        uses: actions/upload-artifact@v4
        with:
          name: deployment-${{ github.run_id }}
          path: deployments/**/SimpleStorage.json
          if-no-files-found: error
          retention-days: 14

      - name: Upload hardhat artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: hardhat-artifact-${{ github.run_id }}
          path: artifacts/contracts/SimpleStorage.sol/SimpleStorage.json
          if-no-files-found: ignore
          retention-days: 14

      # Обновляем переменную, но НЕ роняем джоб при 404/permission
      - name: Update Actions variable SIMPLE_STORAGE
        if: ${{ env.ADDRESS != '' }}
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          set -e
          if [ -z "${GH_TOKEN}" ]; then
            echo "GH_PAT not set, skipping variable update"
            exit 0
          fi
          gh api --method PATCH \
            "repos/${{ github.repository }}/actions/variables/SIMPLE_STORAGE" \
            -f name="SIMPLE_STORAGE" -f value="$ADDRESS" \
          || gh api --method POST \
            "repos/${{ github.repository }}/actions/variables" \
            -f name="SIMPLE_STORAGE" -f value="$ADDRESS" \
          || echo "Skip variable update (permissions or endpoint not available)"

      - name: Rebase with origin/main
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git rebase origin/main || git rebase --abort

      - name: Commit deployments file
        run: |
          git add deployments
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "chore(deploy): persist SimpleStorage at $ADDRESS"

      - name: Push
        run: git push origin HEAD:main
