name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    # прокинем репозиторную переменную как ENV (если есть)
    env:
      SIMPLE_STORAGE: ${{ vars.SIMPLE_STORAGE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps (skip optional like fsevents)
        run: npm ci --omit=optional

      - name: Ensure analyzer & Compile
        shell: bash
        run: |
          # если бинарь анализатора недоступен — подтянем его для Linux и скомпилим
          node -e "try{require.resolve('@nomicfoundation/solidity-analyzer-linux-x64-gnu');process.exit(0)}catch(e){process.exit(1)}" \
          || npm i -D @nomicfoundation/solidity-analyzer-linux-x64-gnu
          npx hardhat compile

      # Опциональный смоук-тест чтения, только если есть адрес и RPC
      - name: Smoke: read SimpleStorage (optional)
        if: env.SIMPLE_STORAGE != '' && (secrets.CIRCLE_RPC_URL != '')
        env:
          CIRCLE_RPC_URL: ${{ secrets.CIRCLE_RPC_URL }}
        run: npx hardhat run --network circleLayerTestnet scripts/read.js
